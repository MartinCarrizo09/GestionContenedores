{
  "info": {
    "_postman_id": "tpi-backend-scenarios",
    "name": "TPI Backend - Escenarios de Prueba",
    "description": "Colecci√≥n con escenarios completos para CLIENTE, OPERADOR y TRANSPORTISTA",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "auth": {
    "type": "bearer",
    "bearer": [{"key": "token", "value": "{{authToken}}", "type": "string"}]
  },
  "item": [
    {
      "name": "üîë Autenticaci√≥n",
      "item": [
        {
          "name": "Obtener Token - CLIENTE",
          "event": [{
            "listen": "test",
            "script": {
              "exec": [
                "if (pm.response.code === 200) {",
                "    var jsonData = pm.response.json();",
                "    var token = jsonData.access_token;",
                "    if (token) {",
                "        pm.environment.set('authToken', token);",
                "        pm.collectionVariables.set('authToken', token);",
                "        console.log('‚úÖ Token CLIENTE guardado correctamente');",
                "        console.log('   Token: ' + token.substring(0, 30) + '...');",
                "    } else {",
                "        console.log('‚ùå Error: No se recibi√≥ access_token en la respuesta');",
                "    }",
                "} else {",
                "    console.log('‚ùå Error al obtener token. Status: ' + pm.response.code);",
                "}"
              ],
              "type": "text/javascript"
            }
          }],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "grant_type", "value": "password"},
                {"key": "client_id", "value": "tpi-client"},
                {"key": "username", "value": "cliente@tpi.com"},
                {"key": "password", "value": "cliente123"}
              ]
            },
            "url": "http://localhost:9090/realms/tpi-backend/protocol/openid-connect/token"
          }
        },
        {
          "name": "Obtener Token - OPERADOR",
          "event": [{
            "listen": "test",
            "script": {
              "exec": [
                "if (pm.response.code === 200) {",
                "    var jsonData = pm.response.json();",
                "    var token = jsonData.access_token;",
                "    if (token) {",
                "        pm.environment.set('authToken', token);",
                "        pm.collectionVariables.set('authToken', token);",
                "        console.log('‚úÖ Token OPERADOR guardado correctamente');",
                "        console.log('   Token: ' + token.substring(0, 30) + '...');",
                "    } else {",
                "        console.log('‚ùå Error: No se recibi√≥ access_token en la respuesta');",
                "    }",
                "} else {",
                "    console.log('‚ùå Error al obtener token. Status: ' + pm.response.code);",
                "}"
              ],
              "type": "text/javascript"
            }
          }],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "grant_type", "value": "password"},
                {"key": "client_id", "value": "tpi-client"},
                {"key": "username", "value": "operador@tpi.com"},
                {"key": "password", "value": "operador123"}
              ]
            },
            "url": "http://localhost:9090/realms/tpi-backend/protocol/openid-connect/token"
          }
        },
        {
          "name": "Obtener Token - TRANSPORTISTA",
          "event": [{
            "listen": "test",
            "script": {
              "exec": [
                "if (pm.response.code === 200) {",
                "    var jsonData = pm.response.json();",
                "    var token = jsonData.access_token;",
                "    if (token) {",
                "        pm.environment.set('authToken', token);",
                "        pm.collectionVariables.set('authToken', token);",
                "        console.log('‚úÖ Token TRANSPORTISTA guardado correctamente');",
                "        console.log('   Token: ' + token.substring(0, 30) + '...');",
                "    } else {",
                "        console.log('‚ùå Error: No se recibi√≥ access_token en la respuesta');",
                "    }",
                "} else {",
                "    console.log('‚ùå Error al obtener token. Status: ' + pm.response.code);",
                "}"
              ],
              "type": "text/javascript"
            }
          }],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "grant_type", "value": "password"},
                {"key": "client_id", "value": "tpi-client"},
                {"key": "username", "value": "transportista@tpi.com"},
                {"key": "password", "value": "transportista123"}
              ]
            },
            "url": "http://localhost:9090/realms/tpi-backend/protocol/openid-connect/token"
          }
        }
      ]
    },
    {
      "name": "üìã S1 - CLIENTE: Crear Solicitud y Seguimiento",
      "item": [
        {
          "stepId": "S1-2",
          "actorRole": "CLIENTE",
          "title": "Crear solicitud completa",
          "request": {
            "method": "POST",
            "url": "http://localhost:8080/api/logistica/solicitudes/completa",
            "headers": {
              "Content-Type": "application/json",
              "Authorization": "Bearer <JWT_CLIENTE>"
            },
            "body": {
              "numeroSeguimiento": "CLI-2025-001",
              "origenDireccion": "C√≥rdoba, Argentina",
              "origenLatitud": -31.4201,
              "origenLongitud": -64.1888,
              "destinoDireccion": "Buenos Aires, Argentina",
              "destinoLatitud": -34.6037,
              "destinoLongitud": -58.3816,
              "clienteNombre": "Carlos",
              "clienteApellido": "Cliente",
              "clienteEmail": "carlos.cliente@test.com",
              "clienteTelefono": "+54 341 5555555",
              "clienteCuil": "20-11111111-1",
              "codigoIdentificacion": "CONT-CLI-002",
              "peso": 3000.0,
              "volumen": 35.0
            }
          },
          "expectedSuccess": {
            "status": 201,
            "bodyExample": {
              "idSolicitud": 2,
              "numeroSeguimiento": "CLI-2025-001",
              "estado": "PENDIENTE"
            },
            "notes": "El Gateway valida el JWT con Keycloak y enruta al microservicio de Log√≠stica. Log√≠stica crea cliente/contendedor si corresponde y deja la solicitud en estado inicial."
          },
          "expectedErrors": [
            {
              "status": 401,
              "when": "Sin token o token inv√°lido",
              "bodyExample": {
                "error": "unauthorized",
                "message": "Missing or invalid Authorization header"
              }
            },
            {
              "status": 403,
              "when": "Token v√°lido pero no es rol CLIENTE o OPERADOR",
              "bodyExample": {
                "error": "forbidden",
                "message": "Access Denied"
              }
            },
            {
              "status": 400,
              "when": "Datos obligatorios faltantes o volumen/peso negativos",
              "bodyExample": {
                "error": "validation_error",
                "details": ["peso must be > 0", "volumen must be > 0"]
              }
            }
          ]
        },
        {
          "stepId": "S1-3",
          "actorRole": "CLIENTE",
          "title": "Consultar estado del contenedor por ID",
          "request": {
            "method": "GET",
            "url": "http://localhost:8080/api/gestion/contenedores/1/estado",
            "headers": {
              "Authorization": "Bearer <JWT_CLIENTE>"
            }
          },
          "expectedSuccess": {
            "status": 200,
            "bodyExample": {
              "idContenedor": 1,
              "codigoIdentificacion": "CONT-CLI-002",
              "estado": "EN_TRANSITO",
              "ubicacionActual": "En viaje",
              "nombreCliente": "Carlos Cliente"
            },
            "notes": "El cliente puede consultar el estado de sus contenedores. El servicio de Gesti√≥n consulta al servicio de Log√≠stica para obtener la informaci√≥n de tramos."
          },
          "expectedErrors": [
            {
              "status": 404,
              "when": "Contenedor no encontrado o no pertenece al cliente",
              "bodyExample": {
                "error": "not_found",
                "message": "Contenedor no encontrado"
              }
            },
            {
              "status": 403,
              "when": "Intenta ver contenedor de otro cliente",
              "bodyExample": {
                "error": "forbidden",
                "message": "No tiene permisos para ver este contenedor"
              }
            }
          ]
        },
        {
          "stepId": "S1-4",
          "actorRole": "CLIENTE",
          "title": "Consultar seguimiento por n√∫mero",
          "request": {
            "method": "GET",
            "url": "http://localhost:8080/api/logistica/solicitudes/seguimiento/CLI-2025-001",
            "headers": {
              "Authorization": "Bearer <JWT_CLIENTE>"
            }
          },
          "expectedSuccess": {
            "status": 200,
            "bodyExample": {
              "numeroSeguimiento": "CLI-2025-001",
              "estado": "EN_TRANSITO",
              "ubicacionActual": "En viaje a Dep√≥sito B",
              "historialEstados": [
                "PENDIENTE",
                "PROGRAMADA",
                "EN_TRANSITO"
              ]
            },
            "notes": "El cliente solo puede ver sus propias solicitudes. El microservicio de Log√≠stica arma el DTO con info de tramos y contenedor."
          },
          "expectedErrors": [
            {
              "status": 404,
              "when": "N√∫mero de seguimiento inexistente o de otro cliente",
              "bodyExample": {
                "error": "not_found",
                "message": "Solicitud no encontrada o no pertenece a este cliente"
              }
            }
          ]
        }
      ]
    },

    {
      "id": "S2_OPERADOR_ESTIMA_RUTA_ASIGNA_RUTA_Y_CAMION",
      "description": "Operador toma una solicitud pendiente, estima ruta, crea la ruta en el sistema y asigna un cami√≥n respetando reglas de negocio.",
      "steps": [
        {
          "stepId": "S2-1",
          "actorRole": "OPERADOR",
          "title": "Login operador",
          "request": {
            "method": "POST",
            "url": "http://localhost:9090/realms/tpi-backend/protocol/openid-connect/token",
            "headers": {
              "Content-Type": "application/x-www-form-urlencoded"
            },
            "body": {
              "grant_type": "password",
              "client_id": "tpi-client",
              "username": "operador@tpi.com",
              "password": "operador123"
            }
          },
          "expectedSuccess": {
            "status": 200,
            "bodyExample": { "access_token": "<JWT_OPERADOR>" }
          },
          "expectedErrors": [
            {
              "status": 401,
              "when": "Credenciales inv√°lidas"
            }
          ]
        },
        {
          "stepId": "S2-2",
          "actorRole": "OPERADOR",
          "title": "Estimar ruta para una solicitud pendiente",
          "request": {
            "method": "POST",
            "url": "http://localhost:8080/api/logistica/solicitudes/estimar-ruta",
            "headers": {
              "Content-Type": "application/json",
              "Authorization": "Bearer <JWT_OPERADOR>"
            },
            "body": {
              "origen": "C√≥rdoba, Argentina",
              "destino": "Buenos Aires, Argentina",
              "pesoKg": 3000.0,
              "volumenM3": 35.0
            }
          },
          "expectedSuccess": {
            "status": 200,
            "bodyExample": {
              "costoEstimado": 98524.0,
              "tramos": [
                { "orden": 1, "origen": "C√≥rdoba", "destino": "Dep√≥sito A" },
                { "orden": 2, "origen": "Dep√≥sito A", "destino": "Buenos Aires" }
              ]
            },
            "notes": "Mismo comportamiento que en S1-3, pero ahora usado por el rol operador para tomar decisiones operativas."
          },
          "expectedErrors": [
            {
              "status": 403,
              "when": "Un CLIENTE o TRANSPORTISTA intenta llamar a este endpoint reservado a operador",
              "bodyExample": {
                "error": "forbidden",
                "message": "Access Denied"
              }
            },
            {
              "status": 502,
              "when": "Error de la API de Google (timeout o 5xx)",
              "bodyExample": {
                "error": "external_service_error",
                "message": "Google Distance Matrix is unavailable"
              }
            },
            {
              "status": 400,
              "when": "Direcciones inv√°lidas o sin ruta",
              "bodyExample": {
                "error": "route_not_found",
                "message": "No se pudo calcular una ruta entre origen y destino"
              }
            }
          ]
        },
        {
          "stepId": "S2-3",
          "actorRole": "OPERADOR",
          "title": "Asignar ruta a una solicitud",
          "request": {
            "method": "POST",
            "url": "http://localhost:8080/api/logistica/solicitudes/2/asignar-ruta",
            "headers": {
              "Content-Type": "application/json",
              "Authorization": "Bearer <JWT_OPERADOR>"
            },
            "body": {
              "origen": "C√≥rdoba, Argentina",
              "destino": "Buenos Aires, Argentina",
              "pesoKg": 3000.0,
              "volumenM3": 35.0
            }
          },
          "expectedSuccess": {
            "status": 200,
            "bodyExample": {
              "id": 2,
              "numeroSeguimiento": "CLI-2025-001",
              "estado": "PROGRAMADA",
              "costoEstimado": 98524.0,
              "tiempoEstimadoHoras": 11.5
            },
            "notes": "El endpoint /asignar-ruta crea autom√°ticamente la ruta y los tramos asociados. La solicitud cambia a estado PROGRAMADA."
          },
          "expectedErrors": [
            {
              "status": 404,
              "when": "idSolicitud inexistente",
              "bodyExample": {
                "error": "not_found",
                "message": "Solicitud 2 no existe"
              }
            },
            {
              "status": 409,
              "when": "La solicitud ya tiene una ruta definitiva asignada",
              "bodyExample": {
                "error": "conflict",
                "message": "La solicitud ya tiene una ruta asociada"
              }
            }
          ]
        },
        {
          "stepId": "S2-4",
          "actorRole": "OPERADOR",
          "title": "Asignar cami√≥n a un tramo",
          "request": {
            "method": "PUT",
            "url": "http://localhost:8080/api/logistica/tramos/10/asignar-camion?patente=ABC123&peso=3000&volumen=25",
            "headers": {
              "Authorization": "Bearer <JWT_OPERADOR>"
            }
          },
          "expectedSuccess": {
            "status": 200,
            "bodyExample": {
              "idTramo": 10,
              "estado": "ASIGNADO",
              "camionPatente": "ABC123"
            },
            "notes": "El servicio de Log√≠stica valida disponibilidad y capacidad del cami√≥n llamando al microservicio de Flota. Si todo est√° OK, el tramo queda ASIGNADO."
          },
          "expectedErrors": [
            {
              "status": 400,
              "when": "peso o volumen del contenedor supera la capacidad del cami√≥n",
              "bodyExample": {
                "error": "capacity_exceeded",
                "message": "El cami√≥n ABC123 no soporta el peso/volumen indicado"
              }
            },
            {
              "status": 404,
              "when": "Patente o tramo inexistentes"
            },
            {
              "status": 403,
              "when": "Un CLIENTE o TRANSPORTISTA intenta asignar camiones",
              "bodyExample": {
                "error": "forbidden",
                "message": "Solo OPERADOR puede asignar camiones"
              }
            }
          ]
        }
      ]
    },

    {
      "id": "S3_TRANSPORTISTA_INICIA_Y_FINALIZA_TRAMO",
      "description": "Transportista ve sus tramos asignados y registra inicio y fin de viaje. Se muestra tambi√©n qu√© pasa si otro rol intenta hacerlo.",
      "steps": [
        {
          "stepId": "S3-1",
          "actorRole": "TRANSPORTISTA",
          "title": "Login transportista",
          "request": {
            "method": "POST",
            "url": "http://localhost:9090/realms/tpi-backend/protocol/openid-connect/token",
            "headers": {
              "Content-Type": "application/x-www-form-urlencoded"
            },
            "body": {
              "grant_type": "password",
              "client_id": "tpi-client",
              "username": "transportista@tpi.com",
              "password": "transportista123"
            }
          },
          "expectedSuccess": {
            "status": 200,
            "bodyExample": { "access_token": "<JWT_TRANSPORTISTA>" }
          }
        },
        {
          "stepId": "S3-2",
          "actorRole": "TRANSPORTISTA",
          "title": "Ver tramos asignados a su cami√≥n",
          "request": {
            "method": "GET",
            "url": "http://localhost:8080/api/logistica/tramos/camion/ABC123",
            "headers": {
              "Authorization": "Bearer <JWT_TRANSPORTISTA>"
            }
          },
          "expectedSuccess": {
            "status": 200,
            "bodyExample": [
              { "id": 10, "estado": "ASIGNADO" },
              { "id": 11, "estado": "ESTIMADO" }
            ],
            "notes": "El transportista ve solo los tramos del cami√≥n que maneja."
          }
        },
        {
          "stepId": "S3-3",
          "actorRole": "TRANSPORTISTA",
          "title": "Iniciar tramo",
          "request": {
            "method": "PATCH",
            "url": "http://localhost:8080/api/logistica/tramos/10/iniciar",
            "headers": {
              "Authorization": "Bearer <JWT_TRANSPORTISTA>"
            }
          },
          "expectedSuccess": {
            "status": 200,
            "bodyExample": {
              "idTramo": 10,
              "estado": "INICIADO",
              "fechaHoraInicioReal": "2025-11-20T08:05:00"
            }
          },
          "expectedErrors": [
            {
              "status": 403,
              "when": "Un CLIENTE intenta iniciar el tramo",
              "bodyExample": {
                "error": "forbidden",
                "message": "Access Denied"
              }
            },
            {
              "status": 409,
              "when": "El tramo no est√° en estado ASIGNADO",
              "bodyExample": {
                "error": "invalid_state",
                "message": "Solo se pueden iniciar tramos en estado ASIGNADO"
              }
            }
          ]
        },
        {
          "stepId": "S3-4",
          "actorRole": "TRANSPORTISTA",
          "title": "Finalizar tramo",
          "request": {
            "method": "PATCH",
            "url": "http://localhost:8080/api/logistica/tramos/10/finalizar?kmReales=715.5&costoKmCamion=120&consumoCamion=0.3",
            "headers": {
              "Authorization": "Bearer <JWT_TRANSPORTISTA>"
            }
          },
          "expectedSuccess": {
            "status": 200,
            "bodyExample": {
              "idTramo": 10,
              "estado": "FINALIZADO",
              "kmReales": 715.5,
              "costoReal": 123456.78
            },
            "notes": "Aqu√≠ se recalcula el costo real del tramo y se actualiza tambi√©n el costo/tiempo real de la solicitud."
          },
          "expectedErrors": [
            {
              "status": 409,
              "when": "Se intenta finalizar un tramo que no est√° INICIADO",
              "bodyExample": {
                "error": "invalid_state",
                "message": "Solo se pueden finalizar tramos en estado INICIADO"
              }
            },
            {
              "status": 403,
              "when": "El token pertenece a un transportista distinto al asignado al cami√≥n",
              "bodyExample": {
                "error": "forbidden",
                "message": "El tramo no pertenece a este transportista"
              }
            }
          ]
        }
      ]
    }
  ]
}

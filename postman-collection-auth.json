{
	"info": {
		"name": "TPI Backend - Auth & Testing",
		"description": "Colecci√≥n completa para autenticaci√≥n con Keycloak y testing de endpoints del TPI Backend",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:8080",
			"type": "string"
		},
		{
			"key": "access_token",
			"value": "",
			"type": "string"
		},
		{
			"key": "refresh_token",
			"value": "",
			"type": "string"
		},
		{
			"key": "expires_in",
			"value": "300",
			"type": "string"
		},
		{
			"key": "token_timestamp",
			"value": "",
			"type": "string"
		}
	],
	"item": [
		{
			"name": "üîê Autenticaci√≥n",
			"item": [
				{
					"name": "Login - Cliente",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// Guardar tokens autom√°ticamente",
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    pm.collectionVariables.set(\"access_token\", jsonData.access_token);",
									"    pm.collectionVariables.set(\"refresh_token\", jsonData.refresh_token);",
									"    pm.collectionVariables.set(\"expires_in\", jsonData.expires_in);",
									"    pm.collectionVariables.set(\"token_timestamp\", Date.now());",
									"    ",
									"    console.log(\"‚úÖ TOKENS GUARDADOS AUTOM√ÅTICAMENTE\");",
									"    console.log(\"   Access token expira en: \" + jsonData.expires_in + \" segundos\");",
									"    console.log(\"   Refresh token expira en: \" + jsonData.refresh_expires_in + \" segundos\");",
									"    console.log(\"   Token type: \" + jsonData.token_type);",
									"    ",
									"    pm.test(\"Login exitoso\", function () {",
									"        pm.response.to.have.status(200);",
									"    });",
									"    ",
									"    pm.test(\"Access token recibido\", function () {",
									"        pm.expect(jsonData.access_token).to.be.a('string');",
									"        pm.expect(jsonData.access_token.length).to.be.above(100);",
									"    });",
									"} else {",
									"    console.log(\"‚ùå ERROR: Credenciales inv√°lidas\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"username\": \"cliente@tpi.com\",\n  \"password\": \"cliente123\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/auth/login",
							"host": ["{{base_url}}"],
							"path": ["auth", "login"]
						},
						"description": "Obtiene access_token y refresh_token para un usuario con rol CLIENTE"
					},
					"response": []
				},
				{
					"name": "Login - Operador",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    pm.collectionVariables.set(\"access_token\", jsonData.access_token);",
									"    pm.collectionVariables.set(\"refresh_token\", jsonData.refresh_token);",
									"    pm.collectionVariables.set(\"expires_in\", jsonData.expires_in);",
									"    pm.collectionVariables.set(\"token_timestamp\", Date.now());",
									"    console.log(\"‚úÖ Tokens guardados (OPERADOR)\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"username\": \"operador@tpi.com\",\n  \"password\": \"operador123\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/auth/login",
							"host": ["{{base_url}}"],
							"path": ["auth", "login"]
						},
						"description": "Obtiene tokens para un usuario con rol OPERADOR"
					},
					"response": []
				},
				{
					"name": "Login - Transportista",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    pm.collectionVariables.set(\"access_token\", jsonData.access_token);",
									"    pm.collectionVariables.set(\"refresh_token\", jsonData.refresh_token);",
									"    pm.collectionVariables.set(\"expires_in\", jsonData.expires_in);",
									"    pm.collectionVariables.set(\"token_timestamp\", Date.now());",
									"    console.log(\"‚úÖ Tokens guardados (TRANSPORTISTA)\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"username\": \"transportista@tpi.com\",\n  \"password\": \"transportista123\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/auth/login",
							"host": ["{{base_url}}"],
							"path": ["auth", "login"]
						},
						"description": "Obtiene tokens para un usuario con rol TRANSPORTISTA"
					},
					"response": []
				},
				{
					"name": "Refresh Token",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    pm.collectionVariables.set(\"access_token\", jsonData.access_token);",
									"    pm.collectionVariables.set(\"refresh_token\", jsonData.refresh_token);",
									"    pm.collectionVariables.set(\"expires_in\", jsonData.expires_in);",
									"    pm.collectionVariables.set(\"token_timestamp\", Date.now());",
									"    ",
									"    console.log(\"‚úÖ TOKENS RENOVADOS AUTOM√ÅTICAMENTE\");",
									"    console.log(\"   Nuevo access token expira en: \" + jsonData.expires_in + \" segundos\");",
									"    ",
									"    pm.test(\"Refresh exitoso\", function () {",
									"        pm.response.to.have.status(200);",
									"    });",
									"} else {",
									"    console.log(\"‚ùå ERROR: Refresh token inv√°lido o expirado\");",
									"    console.log(\"   Ejecuta un Login nuevamente para obtener tokens frescos\");",
									"}"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// Verificar si hay refresh_token disponible",
									"var refreshToken = pm.collectionVariables.get(\"refresh_token\");",
									"if (!refreshToken) {",
									"    console.log(\"‚ö†Ô∏è No hay refresh_token disponible. Ejecuta un Login primero.\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"refreshToken\": \"{{refresh_token}}\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/auth/refresh",
							"host": ["{{base_url}}"],
							"path": ["auth", "refresh"]
						},
						"description": "Renueva el access_token usando el refresh_token"
					},
					"response": []
				},
				{
					"name": "Auth Info",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/auth/info",
							"host": ["{{base_url}}"],
							"path": ["auth", "info"]
						},
						"description": "Informaci√≥n sobre el servicio de autenticaci√≥n"
					},
					"response": []
				}
			],
			"description": "Endpoints para autenticaci√≥n y gesti√≥n de tokens"
		},
		{
			"name": "üì¶ Gesti√≥n - Contenedores",
			"item": [
				{
					"name": "Listar Contenedores (OPERADOR)",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// Pre-request: Verificar expiraci√≥n del token",
									"var tokenTimestamp = pm.collectionVariables.get(\"token_timestamp\");",
									"var expiresIn = parseInt(pm.collectionVariables.get(\"expires_in\") || 300);",
									"",
									"if (tokenTimestamp) {",
									"    var elapsed = (Date.now() - tokenTimestamp) / 1000;",
									"    var remaining = expiresIn - elapsed;",
									"    ",
									"    if (remaining <= 0) {",
									"        console.log(\"‚ö†Ô∏è TOKEN EXPIRADO - Ejecuta 'Refresh Token' o 'Login' primero\");",
									"    } else if (remaining < 60) {",
									"        console.log(\"‚ö†Ô∏è Token expira en \" + Math.floor(remaining) + \" segundos - Considera renovarlo\");",
									"    } else {",
									"        console.log(\"‚úÖ Token v√°lido (expira en \" + Math.floor(remaining) + \" segundos)\");",
									"    }",
									"} else {",
									"    console.log(\"‚ö†Ô∏è No hay token - Ejecuta 'Login' primero\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/gestion/contenedores",
							"host": ["{{base_url}}"],
							"path": ["api", "gestion", "contenedores"]
						},
						"description": "Lista todos los contenedores (requiere rol OPERADOR)"
					},
					"response": []
				},
				{
					"name": "Consultar Estado Contenedor (CLIENTE)",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/gestion/contenedores/codigo/CONT001/estado",
							"host": ["{{base_url}}"],
							"path": ["api", "gestion", "contenedores", "codigo", "CONT001", "estado"]
						},
						"description": "Consulta el estado de un contenedor por c√≥digo (requiere rol CLIENTE)"
					},
					"response": []
				}
			],
			"description": "Endpoints de gesti√≥n de contenedores",
			"auth": {
				"type": "bearer",
				"bearer": [
					{
						"key": "token",
						"value": "{{access_token}}",
						"type": "string"
					}
				]
			}
		},
		{
			"name": "üöö Log√≠stica - Solicitudes",
			"item": [
				{
					"name": "Crear Solicitud de Transporte (CLIENTE)",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"clienteId\": 1,\n  \"contenedorId\": \"CONT001\",\n  \"origenDireccion\": \"Av. Corrientes 1234, CABA\",\n  \"origenLatitud\": -34.6037,\n  \"origenLongitud\": -58.3816,\n  \"destinoDireccion\": \"Av. Rivadavia 5678, CABA\",\n  \"destinoLatitud\": -34.6131,\n  \"destinoLongitud\": -58.4353\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/logistica/solicitudes",
							"host": ["{{base_url}}"],
							"path": ["api", "logistica", "solicitudes"]
						},
						"description": "Crea una nueva solicitud de transporte (requiere rol CLIENTE)"
					},
					"response": []
				},
				{
					"name": "Listar Solicitudes (OPERADOR)",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/logistica/solicitudes",
							"host": ["{{base_url}}"],
							"path": ["api", "logistica", "solicitudes"]
						},
						"description": "Lista todas las solicitudes (requiere rol OPERADOR)"
					},
					"response": []
				},
				{
					"name": "Estimar Ruta (OPERADOR)",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"origenLatitud\": -34.6037,\n  \"origenLongitud\": -58.3816,\n  \"destinoLatitud\": -34.6131,\n  \"destinoLongitud\": -58.4353,\n  \"pesoKg\": 4800,\n  \"volumenM3\": 33\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/logistica/solicitudes/estimar-ruta",
							"host": ["{{base_url}}"],
							"path": ["api", "logistica", "solicitudes", "estimar-ruta"]
						},
						"description": "Estima costos de una ruta (requiere rol OPERADOR)"
					},
					"response": []
				}
			],
			"description": "Endpoints de gesti√≥n log√≠stica",
			"auth": {
				"type": "bearer",
				"bearer": [
					{
						"key": "token",
						"value": "{{access_token}}",
						"type": "string"
					}
				]
			}
		},
		{
			"name": "üöõ Flota - Camiones",
			"item": [
				{
					"name": "Listar Camiones (OPERADOR)",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/flota/camiones",
							"host": ["{{base_url}}"],
							"path": ["api", "flota", "camiones"]
						},
						"description": "Lista todos los camiones (requiere rol OPERADOR)"
					},
					"response": []
				},
				{
					"name": "Camiones Disponibles (OPERADOR)",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/flota/camiones?disponible=true",
							"host": ["{{base_url}}"],
							"path": ["api", "flota", "camiones"],
							"query": [
								{
									"key": "disponible",
									"value": "true"
								}
							]
						},
						"description": "Lista solo camiones disponibles (requiere rol OPERADOR)"
					},
					"response": []
				}
			],
			"description": "Endpoints de gesti√≥n de flota",
			"auth": {
				"type": "bearer",
				"bearer": [
					{
						"key": "token",
						"value": "{{access_token}}",
						"type": "string"
					}
				]
			}
		},
		{
			"name": "üîí Test de Seguridad",
			"item": [
				{
					"name": "CLIENTE bloqueado de Camiones (403)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"CLIENTE bloqueado correctamente (403)\", function () {",
									"    pm.response.to.have.status(403);",
									"});",
									"",
									"if (pm.response.code === 403) {",
									"    console.log(\"‚úÖ Seguridad funcionando: CLIENTE no puede acceder a camiones\");",
									"} else {",
									"    console.log(\"‚ùå PROBLEMA: CLIENTE deber√≠a recibir 403\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/flota/camiones",
							"host": ["{{base_url}}"],
							"path": ["api", "flota", "camiones"]
						},
						"description": "Verifica que CLIENTE no puede acceder a camiones (debe retornar 403)"
					},
					"response": []
				}
			],
			"description": "Tests de seguridad y control de acceso por roles",
			"auth": {
				"type": "bearer",
				"bearer": [
					{
						"key": "token",
						"value": "{{access_token}}",
						"type": "string"
					}
				]
			}
		}
	],
	"auth": {
		"type": "bearer",
		"bearer": [
			{
				"key": "token",
				"value": "{{access_token}}",
				"type": "string"
			}
		]
	},
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Script global: verificar expiraci√≥n del token antes de cada request",
					"var tokenTimestamp = pm.collectionVariables.get(\"token_timestamp\");",
					"var expiresIn = parseInt(pm.collectionVariables.get(\"expires_in\") || 300);",
					"",
					"if (tokenTimestamp && pm.request.url.path.join('/').indexOf('auth/') === -1) {",
					"    var elapsed = (Date.now() - tokenTimestamp) / 1000;",
					"    var remaining = expiresIn - elapsed;",
					"    ",
					"    if (remaining <= 0) {",
					"        console.log(\"‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è TOKEN EXPIRADO\");",
					"        console.log(\"   Ejecuta 'Refresh Token' o 'Login' antes de continuar\");",
					"    } else if (remaining < 30) {",
					"        console.log(\"‚ö†Ô∏è Token expirar√° pronto (\" + Math.floor(remaining) + \" segundos)\");",
					"    }",
					"}"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	]
}

# ============================================================
# API Gateway - Spring Cloud Gateway + Keycloak
# Puerto: 8080 (entrada única al sistema)
# ============================================================

server:
  port: ${GATEWAY_PORT:8080}

spring:
  application:
    name: api-gateway
  
  # ========== Spring Cloud Gateway Configuration ==========
  cloud:
    gateway:
      # Habilitar descubrimiento automático de rutas
      discovery:
        locator:
          enabled: false  # Usamos configuración manual para más control
      
      # Configuración global de CORS
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - PATCH
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            exposedHeaders:
              - Authorization
            allowCredentials: false
            maxAge: 3600
      
      # ========== RUTAS A MICROSERVICIOS ==========
      routes:
        # ==================== SERVICIO GESTIÓN ====================
        - id: servicio-gestion
          uri: ${SERVICIO_GESTION_URL:http://servicio-gestion:8081}
          predicates:
            - Path=/api/gestion/**
          filters:
            - RewritePath=/api/gestion/(?<segment>.*), /api-gestion/$\{segment}
            - name: CircuitBreaker
              args:
                name: gestionCircuitBreaker
                fallbackUri: forward:/fallback/gestion
        
        # ==================== SERVICIO FLOTA ====================
        - id: servicio-flota
          uri: ${SERVICIO_FLOTA_URL:http://servicio-flota:8082}
          predicates:
            - Path=/api/flota/**
          filters:
            - RewritePath=/api/flota/(?<segment>.*), /api-flota/$\{segment}
            - name: CircuitBreaker
              args:
                name: flotaCircuitBreaker
                fallbackUri: forward:/fallback/flota
        
        # ==================== SERVICIO LOGÍSTICA ====================
        - id: servicio-logistica
          uri: ${SERVICIO_LOGISTICA_URL:http://servicio-logistica:8083}
          predicates:
            - Path=/api/logistica/**
          filters:
            - RewritePath=/api/logistica/(?<segment>.*), /api-logistica/$\{segment}
            - name: CircuitBreaker
              args:
                name: logisticaCircuitBreaker
                fallbackUri: forward:/fallback/logistica
        
        # ==================== KEYCLOAK (para obtener tokens) ====================
        - id: keycloak-auth
          uri: ${KEYCLOAK_URL:http://keycloak:9090}
          predicates:
            - Path=/auth/**
          filters:
            - RemoveRequestHeader=Cookie  # Evita problemas de sesión
  
  # ========== Security OAuth2 Resource Server (Keycloak) ==========
  security:
    oauth2:
      resourceserver:
        jwt:
          # IMPORTANTE: El issuer-uri debe coincidir EXACTAMENTE con el 'iss' claim del token JWT
          # Si los tokens se obtienen desde el host usando localhost:9090, el issuer será localhost:9090
          # El Gateway valida el issuer del token, pero obtiene los JWKs usando la URL interna de Docker
          issuer-uri: ${KEYCLOAK_ISSUER_URI:http://localhost:9090/realms/tpi-backend}
          # Lista de issuers permitidos (separados por coma)
          # Permite validar tokens obtenidos tanto internamente (keycloak:9090) como externamente (localhost:9090)
          allowed-issuers: ${KEYCLOAK_ALLOWED_ISSUERS:http://localhost:9090/realms/tpi-backend,http://keycloak:9090/realms/tpi-backend}
          # El jwk-set-uri usa el nombre del contenedor porque el Gateway obtiene las claves desde dentro de Docker
          jwk-set-uri: ${KEYCLOAK_JWK_SET_URI:http://keycloak:9090/realms/tpi-backend/protocol/openid-connect/certs}

# ========== Actuator (Health Checks) ==========
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway,metrics
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true

# ========== Logging ==========
logging:
  level:
    org.springframework.cloud.gateway: ${GATEWAY_LOG_LEVEL:INFO}
    org.springframework.security: ${SECURITY_LOG_LEVEL:INFO}
    reactor.netty: ${NETTY_LOG_LEVEL:INFO}
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# ========== Configuración de Resilience (Circuit Breaker) ==========
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 30000
        permittedNumberOfCallsInHalfOpenState: 3
    instances:
      gestionCircuitBreaker:
        baseConfig: default
      flotaCircuitBreaker:
        baseConfig: default
      logisticaCircuitBreaker:
        baseConfig: default
